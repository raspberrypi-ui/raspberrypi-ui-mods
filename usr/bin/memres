#!/bin/sh

TOTAL_MEM=$(vcgencmd get_config total_mem | cut -d = -f 2)
if ! grep -q profile "$HOME/.config/kanshi/config" ; then
  if [ $TOTAL_MEM -le 1024 ] ; then
    FIX='no'
    HDMI_PROFILE='profile {\n'
    HDMI1_RES=$(wlr-randr | sed -n '/^HDMI-A-1/,/Position/{/preferred/p}' | cut -d' ' -f5 | cut -dx -f2)
    if ! [ -z $HDMI1_RES ] ; then
      if [ $HDMI1_RES -gt 1080 ] ; then
        FIX='yes'
        PREF_RES1=$(wlr-randr | sed -n '/^HDMI-A-1/,/Position/{/1080/p}' | head -1 | sed 's/ //g' | sed 's/px,/@/' | sed 's/Hz.*/Hz/' )
      else
        PREF_RES1=$(wlr-randr | sed -n '/^HDMI-A-1/,/Position/{/current/p}' | sed 's/ //g' | sed 's/px,/@/' | sed 's/Hz.*/Hz/' )
      fi
      HDMI_PROFILE=$HDMI_PROFILE"\toutput HDMI-A-1 mode "$PREF_RES1" position 0,0 transform normal\n"
      HDMI2_POS=$(echo $PREF_RES1 | sed 's/@.*//'| sed 's/x.*/,0/' )

      HDMI2_RES=$(wlr-randr | sed -n '/^HDMI-A-2/,/Position/{/preferred/p}' | cut -d' ' -f5 | cut -dx -f2)
      if ! [ -z $HDMI2_RES ] ; then
        if [ $HDMI2_RES -gt 1080 ] ; then
          FIX='yes'
          PREF_RES2=$(wlr-randr | sed -n '/^HDMI-A-2/,/Position/{/1080/p}' | head -1 | sed 's/ //g'| sed 's/px,/@/' | sed 's/Hz.*/Hz/')
        else
          PREF_RES2=$(wlr-randr | sed -n '/^HDMI-A-2/,/Position/{/current/p}' |  sed 's/ //g'| sed 's/px,/@/' | sed 's/Hz.*/Hz/')
        fi
        HDMI_PROFILE=$HDMI_PROFILE"\toutput HDMI-A-2 mode "$PREF_RES2" position "$HDMI2_POS" transform normal\n"
      fi
      HDMI_PROFILE=$HDMI_PROFILE"}"
    fi
    if [ "$FIX" = "yes" ] ; then
      echo $HDMI_PROFILE > "$HOME/.config/kanshi/config"
      pkill --signal SIGHUP kanshi
    fi
  fi
fi
